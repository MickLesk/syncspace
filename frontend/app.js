// SyncSpace - Material 3 Expressive SPA
const API_URL=window.location.origin+'/api';let authToken=localStorage.getItem('authToken'),currentView='files',currentPath='',drawerOpen=!0,i18n={en:{appTitle:'SyncSpace',login:{title:'Sign In',subtitle:'Sign in to continue',username:'Username',password:'Password',totp:'2FA Code (optional)',totpHint:'Leave empty if 2FA is not enabled',submit:'Sign In'},nav:{files:'Files',search:'Search',peers:'Peers',settings:'Settings'},files:{title:'Files',upload:'Upload',newFolder:'New Folder',empty:'No files yet. Upload something!',dragDrop:'Drag & drop files here or click upload'},actions:{rename:'Rename',delete:'Delete',download:'Download',preview:'Preview'},dialog:{rename:{title:'Rename',label:'New name',confirm:'Rename',cancel:'Cancel'},delete:{title:'Delete',message:'Delete this item?',warning:'This action cannot be undone!',confirm:'Delete',cancel:'Cancel'},newFolder:{title:'New Folder',label:'Folder name',placeholder:'My Folder',confirm:'Create',cancel:'Cancel'}},settings:{title:'Settings',theme:'Theme',darkMode:'Dark Mode',security:'Security',twoFactor:'Two-Factor Authentication',setup2FA:'Setup 2FA',changePassword:'Change Password'},theme:{toggle:'Toggle theme'},logout:'Logout'},de:{appTitle:'SyncSpace',login:{title:'Anmelden',subtitle:'Melden Sie sich an, um fortzufahren',username:'Benutzername',password:'Passwort',totp:'2FA Code (optional)',totpHint:'Leer lassen, wenn 2FA nicht aktiviert ist',submit:'Anmelden'},nav:{files:'Dateien',search:'Suchen',peers:'Peers',settings:'Einstellungen'},files:{title:'Dateien',upload:'Hochladen',newFolder:'Neuer Ordner',empty:'Noch keine Dateien. Laden Sie etwas hoch!',dragDrop:'Dateien hier ablegen oder auf Hochladen klicken'},actions:{rename:'Umbenennen',delete:'Löschen',download:'Herunterladen',preview:'Vorschau'},dialog:{rename:{title:'Umbenennen',label:'Neuer Name',confirm:'Umbenennen',cancel:'Abbrechen'},delete:{title:'Löschen',message:'Dieses Element löschen?',warning:'Diese Aktion kann nicht rückgängig gemacht werden!',confirm:'Löschen',cancel:'Abbrechen'},newFolder:{title:'Neuer Ordner',label:'Ordnername',placeholder:'Mein Ordner',confirm:'Erstellen',cancel:'Abbrechen'}},settings:{title:'Einstellungen',theme:'Thema',darkMode:'Dunkler Modus',security:'Sicherheit',twoFactor:'Zwei-Faktor-Authentifizierung',setup2FA:'2FA einrichten',changePassword:'Passwort ändern'},theme:{toggle:'Thema wechseln'},logout:'Abmelden'}},currentLang=localStorage.getItem('lang')||'en';function t(e){const n=e.split('.');let a=i18n[currentLang];for(const e of n)if(a=a[e],!a)return e;return a}function setLanguage(e){currentLang=e,localStorage.setItem('lang',e),location.reload()}document.addEventListener('DOMContentLoaded',()=>{hideLoading(),authToken?showApp():showLogin()});function hideLoading(){document.getElementById('loading').classList.add('hidden')}function showLogin(){const e=document.getElementById('login-page');e.classList.remove('hidden'),e.innerHTML=`<div class="login-card"><h1 class="login-title">${t('login.title')}</h1><p class="login-subtitle">${t('login.subtitle')}</p><form class="login-form" id="login-form"><md-filled-text-field id="username-input" label="${t('login.username')}" required></md-filled-text-field><md-filled-text-field id="password-input" label="${t('login.password')}" type="password" required></md-filled-text-field><md-filled-text-field id="totp-input" label="${t('login.totp')}" supporting-text="${t('login.totpHint')}"></md-filled-text-field><md-filled-button type="submit">${t('login.submit')}</md-filled-button></form></div>`,document.getElementById('login-form').addEventListener('submit',handleLogin)}async function handleLogin(e){e.preventDefault();const n=document.getElementById('username-input').value,a=document.getElementById('password-input').value,t=document.getElementById('totp-input').value||void 0;try{const e=await fetch(`${API_URL}/auth/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:n,password:a,totp_code:t})}),r=await e.json();r.token?(authToken=r.token,localStorage.setItem('authToken',authToken),document.getElementById('login-page').classList.add('hidden'),showApp()):r.requires_2fa?alert('Please enter your 2FA code'):alert(r.error||'Login failed')}catch(e){alert('Login error: '+e.message)}}function showApp(){const e=document.getElementById('app');e.classList.remove('hidden'),e.innerHTML=`<div id="top-bar"><div class="bar-left"><md-icon-button id="menu-btn"><span class="material-symbols-outlined">menu</span></md-icon-button><span class="bar-title">${t('appTitle')}</span></div><div class="bar-right"><md-icon-button id="lang-btn" title="Language"><span class="material-symbols-outlined">language</span></md-icon-button><md-icon-button id="theme-btn" title="${t('theme.toggle')}"><span class="material-symbols-outlined">dark_mode</span></md-icon-button><md-icon-button id="logout-btn" title="${t('logout')}"><span class="material-symbols-outlined">logout</span></md-icon-button></div></div><div id="main-content"><nav id="nav-drawer"><div class="nav-item active" data-view="files"><span class="material-symbols-outlined nav-icon">folder</span><span>${t('nav.files')}</span></div><div class="nav-item" data-view="search"><span class="material-symbols-outlined nav-icon">search</span><span>${t('nav.search')}</span></div><div class="nav-item" data-view="peers"><span class="material-symbols-outlined nav-icon">devices</span><span>${t('nav.peers')}</span></div><div class="nav-item" data-view="settings"><span class="material-symbols-outlined nav-icon">settings</span><span>${t('nav.settings')}</span></div></nav><div id="content-area"></div></div><md-fab id="fab" label="${t('files.upload')}"><span slot="icon" class="material-symbols-outlined">add</span></md-fab>`,document.getElementById('menu-btn').addEventListener('click',toggleDrawer),document.getElementById('lang-btn').addEventListener('click',()=>{setLanguage('en'===currentLang?'de':'en')}),document.getElementById('theme-btn').addEventListener('click',toggleTheme),document.getElementById('logout-btn').addEventListener('click',logout),document.getElementById('fab').addEventListener('click',handleFabClick),document.querySelectorAll('.nav-item').forEach(e=>{e.addEventListener('click',()=>{navigate(e.dataset.view)})}),navigate('files'),localStorage.getItem('theme')==='dark'&&(document.body.classList.add('dark-theme'),document.querySelector('#theme-btn span').textContent='light_mode')}function navigate(e){currentView=e,document.querySelectorAll('.nav-item').forEach(n=>{n.classList.toggle('active',n.dataset.view===e)});const n=document.getElementById('content-area');switch(e){case'files':loadFilesView(n);break;case'search':loadSearchView(n);break;case'peers':loadPeersView(n);break;case'settings':loadSettingsView(n)}}async function loadFilesView(e){e.innerHTML=`<div class="breadcrumb" id="breadcrumb"></div><div class="drop-zone" id="drop-zone"><span class="material-symbols-outlined" style="font-size:48px;color:var(--md-sys-color-primary)">cloud_upload</span><p style="margin-top:16px;font-size:18px">${t('files.dragDrop')}</p></div><div class="card"><h2 class="card-title">${t('files.title')}</h2><div id="file-list" class="file-list"><p>Loading...</p></div></div>`,renderBreadcrumb();const n=document.getElementById('drop-zone');n.addEventListener('dragover',e=>{e.preventDefault(),n.classList.add('drag-over')}),n.addEventListener('dragleave',()=>{n.classList.remove('drag-over')}),n.addEventListener('drop',async e=>{e.preventDefault(),n.classList.remove('drag-over');const a=Array.from(e.dataTransfer.files);for(const e of a)await uploadFile(e);loadFilesView(document.getElementById('content-area'))}),n.addEventListener('click',handleFabClick);try{const n=await fetch(`${API_URL}/files/${encodeURIComponent(currentPath)}`,{headers:{Authorization:`Bearer ${authToken}`}}),a=await n.json(),r=document.getElementById('file-list');0===a.length?r.innerHTML=`<p>${t('files.empty')}</p>`:r.innerHTML=a.map(e=>`<div class="file-item" data-name="${e.name}" data-is-dir="${e.is_dir}"><span class="material-symbols-outlined file-icon">${e.is_dir?'folder':'description'}</span><div class="file-info"><div class="file-name">${e.name}</div><div class="file-size">${formatSize(e.size)}</div></div><md-icon-button data-action="download"><span class="material-symbols-outlined">download</span></md-icon-button><md-icon-button data-action="rename"><span class="material-symbols-outlined">edit</span></md-icon-button><md-icon-button data-action="delete"><span class="material-symbols-outlined">delete</span></md-icon-button></div>`).join(''),document.querySelectorAll('.file-item').forEach(e=>{const n=e.dataset.name,a='true'===e.dataset.isDir;e.querySelector('.file-info').addEventListener('click',()=>{a?(currentPath=currentPath?`${currentPath}/${n}`:n,loadFilesView(document.getElementById('content-area'))):previewFile(n)}),e.querySelector('[data-action="download"]').addEventListener('click',e=>{e.stopPropagation(),downloadFile(n)}),e.querySelector('[data-action="rename"]').addEventListener('click',e=>{e.stopPropagation(),renameFile(n)}),e.querySelector('[data-action="delete"]').addEventListener('click',e=>{e.stopPropagation(),deleteFile(n)})})}catch(n){document.getElementById('file-list').innerHTML=`<p>Error: ${n.message}</p>`}}function renderBreadcrumb(){const e=document.getElementById('breadcrumb'),n=currentPath.split('/').filter(e=>e);let a='';e.innerHTML=`<span class="breadcrumb-item" data-path=""><span class="material-symbols-outlined" style="font-size:20px">home</span><span>Home</span></span>`,n.forEach((n,r)=>{a+=`${r>0?'/':''}${n}`,e.innerHTML+=`<span class="breadcrumb-sep">/</span><span class="breadcrumb-item" data-path="${a}">${n}</span>`}),document.querySelectorAll('.breadcrumb-item').forEach(e=>{e.addEventListener('click',()=>{currentPath=e.dataset.path,loadFilesView(document.getElementById('content-area'))})})}async function previewFile(e){alert(`Preview: ${e} (Feature coming soon)`)}async function downloadFile(e){const n=`${currentPath}/${e}`.replace(/^\/+/,''),a=`${API_URL}/file/${encodeURIComponent(n)}`,t=document.createElement('a');t.href=a,t.download=e,t.click()}async function renameFile(e){const n=prompt(t('dialog.rename.label'),e);if(n&&n!==e)try{const a=`${currentPath}/${e}`.replace(/^\/+/,''),r=`${currentPath}/${n}`.replace(/^\/+/,'');(await fetch(`${API_URL}/rename/${encodeURIComponent(a)}`,{method:'PUT',headers:{Authorization:`Bearer ${authToken}`,'Content-Type':'application/json'},body:JSON.stringify({new_path:r})})).ok?loadFilesView(document.getElementById('content-area')):alert('Rename failed')}catch(e){alert('Error: '+e.message)}}async function deleteFile(e){if(confirm(`${t('dialog.delete.message')} ${e}?`))try{const n=`${currentPath}/${e}`.replace(/^\/+/,'');(await fetch(`${API_URL}/files/${encodeURIComponent(n)}`,{method:'DELETE',headers:{Authorization:`Bearer ${authToken}`}})).ok?loadFilesView(document.getElementById('content-area')):alert('Delete failed')}catch(e){alert('Error: '+e.message)}}function loadSearchView(e){e.innerHTML=`<div class="card"><h2 class="card-title">${t('nav.search')}</h2><md-filled-text-field id="search-input" label="Search files..." type="search"></md-filled-text-field><div id="search-results" style="margin-top:24px;"></div></div>`,document.getElementById('search-input').addEventListener('input',async e=>{const n=e.target.value;if(n.length<2)return void(document.getElementById('search-results').innerHTML='');try{const e=await fetch(`${API_URL}/search?q=${encodeURIComponent(n)}`,{headers:{Authorization:`Bearer ${authToken}`}}),a=await e.json();document.getElementById('search-results').innerHTML=0===a.length?'<p>No results</p>':a.map(e=>`<div class="file-item"><span class="material-symbols-outlined file-icon">description</span><div class="file-info"><div class="file-name">${e}</div></div></div>`).join('')}catch(e){document.getElementById('search-results').innerHTML=`<p>Error: ${e.message}</p>`}})}function loadPeersView(e){e.innerHTML=`<div class="card"><h2 class="card-title">${t('nav.peers')}</h2><p>Peer synchronization coming soon...</p></div>`}function loadSettingsView(e){e.innerHTML=`<div class="card"><h2 class="card-title">${t('settings.title')}</h2><div style="margin-bottom:24px"><h3 style="margin-bottom:8px">${t('settings.theme')}</h3><md-switch id="dark-mode-switch"></md-switch><label for="dark-mode-switch" style="margin-left:8px">${t('settings.darkMode')}</label></div><div style="margin-bottom:24px"><h3 style="margin-bottom:8px">${t('settings.security')}</h3><h4 style="margin:8px 0">${t('settings.twoFactor')}</h4><md-filled-button id="setup-2fa-btn">${t('settings.setup2FA')}</md-filled-button></div><div><h4 style="margin:8px 0">${t('settings.changePassword')}</h4><md-filled-button id="change-pwd-btn">${t('settings.changePassword')}</md-filled-button></div></div>`;const n=document.getElementById('dark-mode-switch');n.selected=document.body.classList.contains('dark-theme'),n.addEventListener('change',e=>{e.target.selected?(document.body.classList.add('dark-theme'),localStorage.setItem('theme','dark'),document.querySelector('#theme-btn span').textContent='light_mode'):(document.body.classList.remove('dark-theme'),localStorage.setItem('theme','light'),document.querySelector('#theme-btn span').textContent='dark_mode')}),document.getElementById('setup-2fa-btn').addEventListener('click',setup2FA),document.getElementById('change-pwd-btn').addEventListener('click',changePassword)}async function setup2FA(){try{const e=await fetch(`${API_URL}/auth/2fa/setup`,{headers:{Authorization:`Bearer ${authToken}`}}),n=await e.json();alert(`2FA Secret: ${n.secret}\nQR Code: ${n.qr_code_url}\n\nScan this with your authenticator app.`);const a=prompt('Enter verification code:');if(a){(await fetch(`${API_URL}/auth/2fa/enable`,{method:'POST',headers:{Authorization:`Bearer ${authToken}`,'Content-Type':'application/json'},body:JSON.stringify({totp_code:a})})).ok?alert('2FA enabled successfully!'):alert('Invalid code')}}catch(e){alert('Error: '+e.message)}}async function changePassword(){const e=prompt('Enter current password:'),n=prompt('Enter new password:');if(e&&n)try{(await fetch(`${API_URL}/auth/change-password`,{method:'POST',headers:{Authorization:`Bearer ${authToken}`,'Content-Type':'application/json'},body:JSON.stringify({old_password:e,new_password:n})})).ok?alert('Password changed!'):alert('Failed to change password')}catch(e){alert('Error: '+e.message)}}function toggleDrawer(){drawerOpen=!drawerOpen,document.getElementById('nav-drawer').classList.toggle('closed',!drawerOpen)}function toggleTheme(){document.body.classList.toggle('dark-theme');const e=document.body.classList.contains('dark-theme');localStorage.setItem('theme',e?'dark':'light'),document.querySelector('#theme-btn span').textContent=e?'light_mode':'dark_mode'}function logout(){localStorage.removeItem('authToken'),authToken=null,document.getElementById('app').classList.add('hidden'),showLogin()}function handleFabClick(){const e=document.createElement('input');e.type='file',e.multiple=!0,e.onchange=async n=>{const a=Array.from(n.target.files);for(const e of a)await uploadFile(e);navigate('files')},e.click()}async function uploadFile(e){try{const n=`${currentPath}/${e.name}`.replace(/^\/+/,'');(await fetch(`${API_URL}/upload/${encodeURIComponent(n)}`,{method:'POST',headers:{Authorization:`Bearer ${authToken}`},body:e})).ok?console.log('Uploaded:',e.name):alert(`Upload failed: ${e.name}`)}catch(n){alert(`Upload error: ${n.message}`)}}function formatSize(e){if(0===e)return'0 B';const n=1024,a=['B','KB','MB','GB'],t=Math.floor(Math.log(e)/Math.log(n));return Math.round(e/Math.pow(n,t)*100)/100+' '+a[t]}
