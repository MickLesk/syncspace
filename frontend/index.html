<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncSpace - File Synchronization</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; height: 100%; }
        
        /* THEME VARIABLES */
        :root[data-theme="light"] {
            --primary: #6750a4;
            --secondary: #625b71;
            --bg: #fafafa;
            --surface: #ffffff;
            --text: #202124;
            --text-secondary: #5f6368;
            --border: #dadce0;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        :root[data-theme="dark"] {
            --primary: #d0bcff;
            --secondary: #ccc2dc;
            --bg: #1c1b1f;
            --surface: #2b2930;
            --text: #e6e1e5;
            --text-secondary: #cac4d0;
            --border: #49454f;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
        }
        
        body { background: var(--bg); color: var(--text); display: flex; flex-direction: column; }
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); }
        .login-card { background: var(--surface); border-radius: 24px; padding: 48px; width: 100%; max-width: 400px; box-shadow: var(--shadow-md); }
        .login-logo { width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; font-size: 32px; font-weight: bold; color: white; }
        .login-card h1 { text-align: center; font-size: 28px; margin-bottom: 8px; color: var(--text); }
        .login-card p { text-align: center; color: var(--text-secondary); margin-bottom: 32px; font-size: 14px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 8px; color: var(--text); font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; transition: all 0.2s; background: var(--surface); color: var(--text); }
        .form-group input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(103, 80, 164, 0.1); }
        .login-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 24px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .login-btn:hover { transform: translateY(-2px); }
        .demo-box { margin-top: 24px; padding: 12px; background: rgba(103, 80, 164, 0.1); border-left: 4px solid var(--primary); border-radius: 8px; font-size: 13px; }
        
        .app-container { display: flex; height: 100vh; overflow: hidden; }
        .app-container.hidden { display: none; }
        .header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow-sm); z-index: 100; }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .header-logo { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 18px; }
        .header h1 { font-size: 22px; font-weight: 600; color: var(--text); }
        .header-right { display: flex; align-items: center; gap: 12px; }
        
        /* THEME TOGGLE - IMPROVED */
        .theme-toggle { 
            padding: 10px 16px; 
            background: var(--bg); 
            border: 2px solid var(--border); 
            border-radius: 24px; 
            cursor: pointer; 
            font-size: 20px; 
            transition: all 0.3s; 
            display: flex; 
            align-items: center; 
            gap: 8px;
            font-weight: 600;
        }
        .theme-toggle:hover { 
            background: var(--primary); 
            color: white; 
            border-color: var(--primary);
            transform: scale(1.05);
        }
        
        /* LANGUAGE SELECTOR WITH FLAG */
        .lang-selector { 
            padding: 10px 14px; 
            background: var(--surface); 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px; 
            color: var(--text); 
            display: flex; 
            align-items: center; 
            gap: 6px;
            font-weight: 500;
        }
        .lang-flag { font-size: 18px; }
        
        .logout-btn { padding: 8px 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.2s; color: var(--text-secondary); }
        .logout-btn:hover { background: var(--bg); }
        
        .sidebar { width: 280px; background: var(--surface); border-right: 1px solid var(--border); overflow-y: auto; padding: 16px 0; }
        .nav-item { padding: 12px 20px; margin: 4px 8px; border-radius: 12px; cursor: pointer; font-size: 14px; color: var(--text-secondary); transition: all 0.2s; border-left: 3px solid transparent; font-weight: 500; display: flex; align-items: center; gap: 12px; }
        .nav-item:hover { background: var(--bg); }
        .nav-item.active { background: var(--bg); color: var(--primary); border-left-color: var(--primary); font-weight: 600; }
        
        .main-content { flex: 1; overflow-y: auto; padding: 32px; background: var(--bg); }
        .page-header { font-size: 28px; font-weight: 600; margin-bottom: 24px; color: var(--text); display: flex; justify-content: space-between; align-items: center; }
        .page-actions { display: flex; gap: 12px; }
        .btn { padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-secondary { background: var(--surface); border: 1px solid var(--border); color: var(--text); }
        .btn-secondary:hover { background: var(--bg); }
        .btn-danger { background: #b3261e; color: white; }
        .btn-success { background: #06a77d; color: white; }
        
        .card { background: var(--surface); border-radius: 16px; padding: 20px; box-shadow: var(--shadow-sm); border: 1px solid var(--border); transition: all 0.2s; }
        .card:hover { box-shadow: var(--shadow-md); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .file-card { position: relative; cursor: pointer; overflow: hidden; }
        .file-icon { font-size: 48px; margin-bottom: 12px; display: block; }
        .file-name { font-weight: 500; color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-bottom: 4px; }
        .file-meta { font-size: 12px; color: var(--text-secondary); }
        .file-actions { display: flex; gap: 8px; margin-top: 12px; }
        .file-actions .btn { flex: 1; padding: 8px; font-size: 12px; }
        
        .hidden { display: none !important; }
        
        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal { background: var(--surface); border-radius: 16px; padding: 32px; width: 90%; max-width: 600px; box-shadow: var(--shadow-md); max-height: 80vh; overflow-y: auto; }
        .modal-header { font-size: 20px; font-weight: 600; margin-bottom: 20px; color: var(--text); }
        .modal-body { margin-bottom: 24px; }
        .modal-footer { display: flex; gap: 12px; justify-content: flex-end; }
        
        /* FILE PREVIEW MODAL */
        .preview-container { text-align: center; }
        .preview-container img { max-width: 100%; max-height: 60vh; border-radius: 8px; }
        .preview-container iframe { width: 100%; height: 60vh; border: none; border-radius: 8px; }
        .preview-container pre { text-align: left; background: var(--bg); padding: 16px; border-radius: 8px; overflow-x: auto; max-height: 60vh; }
        
        /* CONTEXT MENU */
        .context-menu { display: none; position: fixed; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; box-shadow: var(--shadow-md); z-index: 2000; min-width: 200px; }
        .context-menu.open { display: block; }
        .context-menu-item { padding: 12px 16px; cursor: pointer; font-size: 14px; color: var(--text); transition: background 0.2s; display: flex; align-items: center; gap: 12px; }
        .context-menu-item:hover { background: var(--bg); }
        .context-menu-divider { height: 1px; background: var(--border); margin: 4px 0; }
        
        /* UPLOAD AREA - DRAG DROP */
        .upload-area { 
            border: 2px dashed var(--primary); 
            border-radius: 12px; 
            padding: 40px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.2s; 
            background: rgba(103, 80, 164, 0.05); 
        }
        .upload-area:hover { background: rgba(103, 80, 164, 0.1); }
        .upload-area.dragover { 
            background: rgba(103, 80, 164, 0.2); 
            border-color: var(--secondary); 
            border-width: 3px;
            transform: scale(1.02);
        }
        
        /* SEARCH */
        .search-box { width: 100%; max-width: 500px; padding: 12px 16px; border: 1px solid var(--border); border-radius: 24px; font-size: 14px; transition: all 0.2s; margin-bottom: 20px; background: var(--surface); color: var(--text); }
        .search-box:focus { outline: none; border-color: var(--primary); }
        
        /* TOAST NOTIFICATIONS */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 12px; }
        .toast { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 16px 20px; box-shadow: var(--shadow-md); display: flex; align-items: center; gap: 12px; min-width: 300px; animation: slideIn 0.3s ease; }
        .toast.success { border-left: 4px solid #06a77d; }
        .toast.error { border-left: 4px solid #b3261e; }
        .toast.info { border-left: 4px solid var(--primary); }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .user-badge { display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; background: var(--bg); border-radius: 16px; font-size: 13px; }
        .user-avatar { width: 24px; height: 24px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>
    <!-- TOAST CONTAINER -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- LOGIN PAGE -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="login-logo">S</div>
            <h1>SyncSpace</h1>
            <p>Modern File Synchronization</p>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input id="username" type="text" placeholder="admin" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input id="password" type="password" placeholder="" required>
                </div>
                <button type="submit" class="login-btn">Login</button>
            </form>
            <div class="demo-box"><strong>Demo:</strong> admin / admin</div>
        </div>
    </div>

    <!-- APP PAGE -->
    <div id="appPage" class="app-container hidden">
        <div style="width: 100%; display: flex; flex-direction: column;">
            <div class="header">
                <div class="header-left">
                    <div class="header-logo">S</div>
                    <h1>SyncSpace</h1>
                </div>
                <div class="header-right">
                    <button id="langSelector" class="lang-selector">
                        <span class="lang-flag" id="langFlag"></span>
                        <span id="langText">Deutsch</span>
                    </button>
                    <button id="themeToggle" class="theme-toggle">
                        <span id="themeIcon"></span>
                        <span id="themeText">Dark</span>
                    </button>
                    <div class="user-badge">
                        <div class="user-avatar">A</div>
                        <span id="usernameDisplay">Admin</span>
                    </div>
                    <button id="logoutBtn" class="logout-btn">Logout</button>
                </div>
            </div>

            <div class="app-container" style="flex: 1;">
                <nav class="sidebar">
                    <div class="nav-item active" data-view="files"><span></span><span>Files</span></div>
                    <div class="nav-item" data-view="shared"><span></span><span>Shared</span></div>
                    <div class="nav-item" data-view="favorites"><span></span><span>Favorites</span></div>
                    <div class="nav-item" data-view="trash"><span></span><span>Trash</span></div>
                    <div class="nav-item" data-view="users"><span></span><span>Users</span></div>
                    <div class="nav-item" data-view="settings"><span></span><span>Settings</span></div>
                </nav>

                <main class="main-content">
                    <!-- FILES VIEW -->
                    <div id="filesView" class="view">
                        <div class="page-header">
                            <span> Files</span>
                            <div class="page-actions">
                                <button id="uploadBtn" class="btn btn-primary"><span></span><span>Upload</span></button>
                                <button id="newFolderBtn" class="btn btn-secondary"><span></span><span>New Folder</span></button>
                            </div>
                        </div>
                        <input id="searchInput" type="text" class="search-box" placeholder="Search files...">
                        
                        <!-- DRAG DROP AREA -->
                        <div id="dropZone" class="upload-area" style="margin-bottom: 24px;">
                            <p style="font-size: 48px; margin-bottom: 16px;"></p>
                            <p style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Drag & Drop files here</p>
                            <p style="font-size: 14px; color: var(--text-secondary);">or click Upload button above</p>
                        </div>
                        
                        <div id="filesList" class="grid">
                            <!-- Files will be loaded here -->
                        </div>
                    </div>

                    <!-- SHARED VIEW -->
                    <div id="sharedView" class="view hidden">
                        <div class="page-header"><span> Shared Files</span></div>
                        <div id="sharedList"></div>
                    </div>

                    <!-- FAVORITES VIEW -->
                    <div id="favoritesView" class="view hidden">
                        <div class="page-header"><span> Favorites</span></div>
                        <div id="favoritesList" class="grid"></div>
                    </div>

                    <!-- TRASH VIEW -->
                    <div id="trashView" class="view hidden">
                        <div class="page-header">
                            <span> Trash</span>
                            <button class="btn btn-danger" onclick="emptyTrash()">Empty Trash</button>
                        </div>
                        <div id="trashList"></div>
                    </div>

                    <!-- USERS VIEW -->
                    <div id="usersView" class="view hidden">
                        <div class="page-header">
                            <span>👥 User Management</span>
                            <button class="btn btn-primary" onclick="openModal(''addUser'')"><span>➕</span><span>Add User</span></button>
                        </div>
                        <div class="card">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 2px solid var(--border);">
                                        <th style="text-align: left; padding: 12px;">Username</th>
                                        <th style="text-align: left; padding: 12px;">Created</th>
                                        <th style="text-align: left; padding: 12px;">Last Login</th>
                                        <th style="text-align: left; padding: 12px;">2FA</th>
                                        <th style="text-align: left; padding: 12px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersList">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- SETTINGS VIEW -->
                    <div id="settingsView" class="view hidden">
                        <div class="page-header"><span> Settings</span></div>
                        <div class="card">
                            <h3> Appearance</h3>
                            <p style="margin-top: 12px;"><strong>Version:</strong> 2.0.0</p>
                            <p><strong>Backend:</strong> Rust / Warp</p>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- CONTEXT MENU -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" onclick="previewFile()"><span></span><span>Open / Preview</span></div>
        <div class="context-menu-item" onclick="downloadFile()"><span></span><span>Download</span></div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="renameFile()"><span></span><span>Rename</span></div>
        <div class="context-menu-item" onclick="shareFile()"><span></span><span>Share</span></div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="deleteFile()" style="color: #b3261e;"><span></span><span>Delete</span></div>
    </div>

    <!-- MODALS -->
    <!-- Upload Modal -->
    <div id="uploadModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">Upload Files</div>
            <div class="modal-body">
                <input id="fileInput" type="file" multiple style="display: none;">
                <button type="button" class="btn btn-primary" onclick="document.getElementById(''fileInput'').click()" style="width: 100%;">
                    <span></span><span>Select Files</span>
                </button>
                <div id="uploadProgress" style="margin-top: 20px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal(''upload'')">Close</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header" id="previewTitle">File Preview</div>
            <div class="modal-body">
                <div id="previewContent" class="preview-container"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal(''preview'')">Close</button>
                <button class="btn btn-primary" onclick="downloadCurrentFile()"><span></span> Download</button>
            </div>
        </div>
    </div>

    <!-- Rename Modal -->
    <div id="renameModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">Rename File</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>New Name</label>
                    <input type="text" id="renameInput" placeholder="filename.ext">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal(''rename'')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmRename()">Save</button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">Share File</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Share Link</label>
                    <input type="text" id="shareLink" readonly style="background: var(--bg);">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal(''share'')">Cancel</button>
                <button class="btn btn-primary" onclick="copyShareLink()"><span></span> Copy Link</button>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">Delete File</div>
            <div class="modal-body">
                <p>Are you sure you want to delete this file?</p>
                <p style="margin-top: 12px; font-weight: 600;" id="deleteFileName"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal(''delete'')">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- New Folder Modal -->
    <div id="newFolderModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">Create New Folder</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Folder Name</label>
                    <input type="text" id="folderNameInput" placeholder="My Folder">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal(''newFolder'')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmNewFolder()">Create</button>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">Add New User</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="newUsername" placeholder="john.doe">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="newUserPassword" placeholder="••••••••">
                </div>
                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" id="newUserPasswordConfirm" placeholder="••••••••">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal(''addUser'')">Cancel</button>
                <button class="btn btn-primary" onclick="addUser()">Add User</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = ''http://localhost:8080/api'';
        
        const state = {
            isLoggedIn: false,
            currentView: ''files'',
            currentLang: ''de'',
            currentTheme: ''light'',
            currentFile: null,
            currentPath: '''',
            files: []
        };

        function init() {
            loadState();
            setupEventListeners();
            applyTheme(state.currentTheme);
            updateLanguageUI(state.currentLang);
            if (state.isLoggedIn) {
                showApp();
                loadFiles();
            } else {
                showLogin();
            }
        }

        function setupEventListeners() {
            document.getElementById(''loginForm'').addEventListener(''submit'', handleLogin);
            document.getElementById(''logoutBtn'').addEventListener(''click'', handleLogout);
            document.getElementById(''themeToggle'').addEventListener(''click'', toggleTheme);
            document.getElementById(''langSelector'').addEventListener(''click'', toggleLanguage);
            document.getElementById(''uploadBtn'').addEventListener(''click'', () => openModal(''upload''));
            document.getElementById(''newFolderBtn'').addEventListener(''click'', () => openModal(''newFolder''));

            document.querySelectorAll(''.nav-item'').forEach(item => {
                item.addEventListener(''click'', (e) => {
                    const view = e.currentTarget.dataset.view;
                    if (view) switchView(view);
                });
            });

            document.addEventListener(''click'', (e) => {
                if (!e.target.closest(''.context-menu'')) {
                    document.getElementById(''contextMenu'').classList.remove(''open'');
                }
            });

            // DRAG & DROP
            const dropZone = document.getElementById(''dropZone'');
            dropZone.addEventListener(''click'', () => document.getElementById(''fileInput'').click());
            
            dropZone.addEventListener(''dragover'', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add(''dragover'');
            });

            dropZone.addEventListener(''dragleave'', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove(''dragover'');
            });

            dropZone.addEventListener(''drop'', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove(''dragover'');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files);
                }
            });

            document.getElementById(''fileInput'').addEventListener(''change'', (e) => {
                handleFileUpload(e.target.files);
            });
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById(''username'').value;
            const password = document.getElementById(''password'').value;

            try {
                const response = await fetch(''http://localhost:8080/api/auth/login'', {
                    method: ''POST'',
                    headers: { ''Content-Type'': ''application/json'' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok && data.token) {
                    state.isLoggedIn = true;
                    localStorage.setItem(''authToken'', data.token);
                    localStorage.setItem(''username'', data.user.username);
                    localStorage.setItem(''userId'', data.user.id);
                    showToast(''Login successful!'', ''success'');
                    showApp();
                    loadFiles();
                } else if (data.requires_2fa) {
                    // 2FA erforderlich
                    showToast(''2FA required - not implemented yet'', ''info'');
                } else {
                    showToast(data.error || ''Invalid credentials'', ''error'');
                }
            } catch (error) {
                // Fallback wenn Backend nicht läuft
                console.error(''Backend not reachable, using demo mode:'', error);
                if (username === ''admin'' && password === ''admin'') {
                    state.isLoggedIn = true;
                    localStorage.setItem(''authToken'', ''demo-token-'' + Date.now());
                    localStorage.setItem(''username'', username);
                    localStorage.setItem(''userId'', ''demo-user-id'');
                    showToast(''Login successful! (Demo Mode - Backend offline)'', ''success'');
                    showApp();
                    loadFiles();
                } else {
                    showToast(''Invalid credentials (Backend offline - use admin/admin)'', ''error'');
                }
            }
        }

        function handleLogout() {
            state.isLoggedIn = false;
            localStorage.removeItem(''authToken'');
            showLogin();
        }

        function showLogin() {
            document.getElementById(''loginPage'').style.display = ''flex'';
            document.getElementById(''appPage'').classList.add(''hidden'');
        }

        function showApp() {
            document.getElementById(''loginPage'').style.display = ''none'';
            document.getElementById(''appPage'').classList.remove(''hidden'');
            const username = localStorage.getItem(''username'') || ''User'';
            document.getElementById(''usernameDisplay'').textContent = username;
        }

        function switchView(viewName) {
            state.currentView = viewName;
            document.querySelectorAll(''.view'').forEach(v => v.classList.add(''hidden''));
            document.getElementById(viewName + ''View'').classList.remove(''hidden'');
            document.querySelectorAll(''.nav-item'').forEach(item => item.classList.remove(''active''));
            document.querySelector(`[data-view="${viewName}"]`).classList.add(''active'');
            
            // Load data when switching to specific views
            if (viewName === ''users'') {
                loadUsers();
            }
        }

        function toggleTheme() {
            const newTheme = state.currentTheme === ''light'' ? ''dark'' : ''light'';
            applyTheme(newTheme);
        }

        function applyTheme(theme) {
            state.currentTheme = theme;
            document.documentElement.setAttribute(''data-theme'', theme);
            const icon = theme === ''dark'' ? '''' : '''';
            const text = theme === ''dark'' ? ''Light'' : ''Dark'';
            document.getElementById(''themeIcon'').textContent = icon;
            document.getElementById(''themeText'').textContent = text;
            localStorage.setItem(''theme'', theme);
        }

        function toggleLanguage() {
            const newLang = state.currentLang === ''de'' ? ''en'' : ''de'';
            state.currentLang = newLang;
            updateLanguageUI(newLang);
            localStorage.setItem(''lang'', newLang);
        }

        function updateLanguageUI(lang) {
            const flag = lang === ''de'' ? '''' : '''';
            const text = lang === ''de'' ? ''Deutsch'' : ''English'';
            document.getElementById(''langFlag'').textContent = flag;
            document.getElementById(''langText'').textContent = text;
        }

        function openModal(name) {
            document.getElementById(name + ''Modal'').classList.add(''open'');
        }

        function closeModal(name) {
            document.getElementById(name + ''Modal'').classList.remove(''open'');
        }

        function showContextMenu(e, fileName) {
            e.preventDefault();
            e.stopPropagation();
            state.currentFile = fileName;
            const menu = document.getElementById(''contextMenu'');
            menu.style.left = e.clientX + ''px'';
            menu.style.top = e.clientY + ''px'';
            menu.classList.add(''open'');
        }

        // FILE OPERATIONS
        async function loadFiles() {
            try {
                const response = await fetch(`${API_BASE}/files/${state.currentPath}`);
                const files = await response.json();
                state.files = files;
                renderFiles(files);
            } catch (error) {
                console.error(''Failed to load files:'', error);
                showToast(''Failed to load files'', ''error'');
            }
        }

        function renderFiles(files) {
            const container = document.getElementById(''filesList'');
            if (!files || files.length === 0) {
                container.innerHTML = ''<p style="grid-column: 1/-1; text-align: center; color: var(--text-secondary); padding: 40px;">No files yet. Upload some files to get started!</p>'';
                return;
            }
            
            container.innerHTML = files.map(file => `
                <div class="card file-card" onclick="previewFile(''${file.name}'')" oncontextmenu="showContextMenu(event, ''${file.name}'')">
                    <span class="file-icon">${getFileIcon(file.name)}</span>
                    <div class="file-name">${file.name}</div>
                    <div class="file-meta">${formatSize(file.size)}</div>
                    <div class="file-actions" onclick="event.stopPropagation()">
                        <button class="btn btn-secondary" onclick="downloadFile(''${file.name}'')"></button>
                        <button class="btn btn-secondary" onclick="shareFile(''${file.name}'')"></button>
                    </div>
                </div>
            `).join('''');
        }

        function getFileIcon(filename) {
            const ext = filename.split(''.'').pop().toLowerCase();
            const icons = {
                pdf: '''', txt: '''', doc: '''', docx: '''',
                jpg: '''', jpeg: '''', png: '''', gif: '''',
                mp4: '''', avi: '''', mov: '''',
                mp3: '''', wav: '''',
                zip: '''', rar: '''',
                js: '''', html: '''', css: ''''
            };
            return icons[ext] || '''';
        }

        function formatSize(bytes) {
            if (!bytes) return ''0 B'';
            const k = 1024;
            const sizes = [''B'', ''KB'', ''MB'', ''GB''];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + '' '' + sizes[i];
        }

        async function previewFile(fileName) {
            if (!fileName) fileName = state.currentFile;
            state.currentFile = fileName;
            
            const ext = fileName.split(''.'').pop().toLowerCase();
            const previewContent = document.getElementById(''previewContent'');
            document.getElementById(''previewTitle'').textContent = fileName;
            
            const fileUrl = `${API_BASE}/file/${state.currentPath ? state.currentPath + ''/'' : ''''}${fileName}`;
            
            if ([''jpg'', ''jpeg'', ''png'', ''gif'', ''webp''].includes(ext)) {
                previewContent.innerHTML = `<img src="${fileUrl}" alt="${fileName}">`;
            } else if (ext === ''pdf'') {
                previewContent.innerHTML = `<iframe src="${fileUrl}"></iframe>`;
            } else if ([''txt'', ''md'', ''js'', ''html'', ''css'', ''json''].includes(ext)) {
                try {
                    const response = await fetch(fileUrl);
                    const text = await response.text();
                    previewContent.innerHTML = `<pre>${escapeHtml(text)}</pre>`;
                } catch (error) {
                    previewContent.innerHTML = `<p>Cannot preview this file type.</p>`;
                }
            } else {
                previewContent.innerHTML = `<p style="padding: 40px;">Preview not available for this file type.</p><p><button class="btn btn-primary" onclick="downloadFile(''${fileName}'')"> Download instead</button></p>`;
            }
            
            openModal(''preview'');
        }

        function escapeHtml(text) {
            const div = document.createElement(''div'');
            div.textContent = text;
            return div.innerHTML;
        }

        function downloadCurrentFile() {
            downloadFile(state.currentFile);
        }

        async function downloadFile(fileName) {
            if (!fileName) fileName = state.currentFile;
            const fileUrl = `${API_BASE}/file/${state.currentPath ? state.currentPath + ''/'' : ''''}${fileName}`;
            window.open(fileUrl, ''_blank'');
            showToast(`Downloading: ${fileName}`, ''info'');
        }

        function renameFile() {
            document.getElementById(''contextMenu'').classList.remove(''open'');
            document.getElementById(''renameInput'').value = state.currentFile || '''';
            openModal(''rename'');
        }

        async function confirmRename() {
            const newName = document.getElementById(''renameInput'').value.trim();
            if (!newName || !state.currentFile) return;
            
            try {
                const response = await fetch(`${API_BASE}/rename/${state.currentPath ? state.currentPath + ''/'' : ''''}${state.currentFile}`, {
                    method: ''PUT'',
                    headers: { ''Content-Type'': ''application/json'' },
                    body: JSON.stringify({ new_path: newName })
                });
                
                if (response.ok) {
                    showToast(`Renamed to: ${newName}`, ''success'');
                    closeModal(''rename'');
                    loadFiles();
                } else {
                    showToast(''Failed to rename file'', ''error'');
                }
            } catch (error) {
                showToast(''Error renaming file'', ''error'');
            }
        }

        function shareFile(fileName) {
            state.currentFile = fileName || state.currentFile;
            const link = `http://localhost:8080/shared/${Math.random().toString(36).substr(2, 9)}`;
            document.getElementById(''shareLink'').value = link;
            document.getElementById(''contextMenu'').classList.remove(''open'');
            openModal(''share'');
        }

        function copyShareLink() {
            const link = document.getElementById(''shareLink'').value;
            navigator.clipboard.writeText(link);
            showToast(''Link copied to clipboard!'', ''success'');
        }

        function deleteFile() {
            document.getElementById(''deleteFileName'').textContent = state.currentFile || ''this file'';
            document.getElementById(''contextMenu'').classList.remove(''open'');
            openModal(''delete'');
        }

        async function confirmDelete() {
            if (!state.currentFile) return;
            
            try {
                const response = await fetch(`${API_BASE}/files/${state.currentPath ? state.currentPath + ''/'' : ''''}${state.currentFile}`, {
                    method: ''DELETE''
                });
                
                if (response.ok) {
                    showToast(`Deleted: ${state.currentFile}`, ''success'');
                    closeModal(''delete'');
                    loadFiles();
                } else {
                    showToast(''Failed to delete file'', ''error'');
                }
            } catch (error) {
                showToast(''Error deleting file'', ''error'');
            }
        }

        function confirmNewFolder() {
            const name = document.getElementById(''folderNameInput'').value.trim();
            if (!name) return;
            createFolder(name);
        }

        async function createFolder(name) {
            try {
                const response = await fetch(`${API_BASE}/dirs/${state.currentPath ? state.currentPath + ''/'' : ''''}${name}`, {
                    method: ''POST''
                });
                
                if (response.ok) {
                    showToast(`Created folder: ${name}`, ''success'');
                    closeModal(''newFolder'');
                    document.getElementById(''folderNameInput'').value = '''';
                    loadFiles();
                } else {
                    showToast(''Failed to create folder'', ''error'');
                }
            } catch (error) {
                showToast(''Error creating folder'', ''error'');
            }
        }

        async function handleFileUpload(files) {
            const progressDiv = document.getElementById(''uploadProgress'');
            progressDiv.innerHTML = '''';
            
            for (const file of files) {
                const progressItem = document.createElement(''div'');
                progressItem.textContent = `Uploading: ${file.name}...`;
                progressDiv.appendChild(progressItem);
                
                try {
                    const response = await fetch(`${API_BASE}/upload/${state.currentPath ? state.currentPath + ''/'' : ''''}${file.name}`, {
                        method: ''POST'',
                        body: file
                    });
                    
                    if (response.ok) {
                        progressItem.textContent = ` ${file.name}`;
                        showToast(`Uploaded: ${file.name}`, ''success'');
                    } else {
                        progressItem.textContent = ` ${file.name} - Failed`;
                        showToast(`Failed: ${file.name}`, ''error'');
                    }
                } catch (error) {
                    progressItem.textContent = ` ${file.name} - Error`;
                    showToast(`Error: ${file.name}`, ''error'');
                }
            }
            
            setTimeout(() => {
                closeModal(''upload'');
                loadFiles();
            }, 2000);
        }

        // USER MANAGEMENT
        async function loadUsers() {
            try {
                const token = localStorage.getItem(''authToken'');
                const response = await fetch(''http://localhost:8080/api/auth/users'', {
                    headers: { ''Authorization'': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const users = await response.json();
                    renderUsers(users);
                } else {
                    showToast(''Failed to load users'', ''error'');
                }
            } catch (error) {
                console.error(''Failed to load users:'', error);
                showToast(''Error loading users'', ''error'');
            }
        }

        function renderUsers(users) {
            const container = document.getElementById(''usersList'');
            if (!users || users.length === 0) {
                container.innerHTML = ''<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-secondary);">No users found</td></tr>'';
                return;
            }
            
            container.innerHTML = users.map(user => `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: bold;">
                                ${user.username[0].toUpperCase()}
                            </div>
                            <span>${user.username}</span>
                        </div>
                    </td>
                    <td style="padding: 12px;">${new Date(user.created_at).toLocaleDateString()}</td>
                    <td style="padding: 12px;">${user.last_login ? new Date(user.last_login).toLocaleDateString() : ''Never''}</td>
                    <td style="padding: 12px;">${user.totp_enabled ? ''✅ Enabled'' : ''❌ Disabled''}</td>
                    <td style="padding: 12px;">
                        <button class="btn btn-secondary" onclick="changeUserPassword(''${user.username}'')" style="padding: 6px 12px; font-size: 12px;">🔑 Change Password</button>
                    </td>
                </tr>
            `).join('''');
        }

        async function addUser() {
            const username = document.getElementById(''newUsername'').value.trim();
            const password = document.getElementById(''newUserPassword'').value;
            const passwordConfirm = document.getElementById(''newUserPasswordConfirm'').value;
            
            if (!username || !password) {
                showToast(''Please fill in all fields'', ''error'');
                return;
            }
            
            if (password !== passwordConfirm) {
                showToast(''Passwords do not match'', ''error'');
                return;
            }
            
            try {
                const token = localStorage.getItem(''authToken'');
                const response = await fetch(''http://localhost:8080/api/auth/register'', {
                    method: ''POST'',
                    headers: { 
                        ''Content-Type'': ''application/json'',
                        ''Authorization'': `Bearer ${token}`
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast(`User ${username} created successfully!'', ''success'');
                    closeModal(''addUser'');
                    document.getElementById(''newUsername'').value = '''';
                    document.getElementById(''newUserPassword'').value = '''';
                    document.getElementById(''newUserPasswordConfirm'').value = '''';
                    loadUsers();
                } else {
                    showToast(data.error || ''Failed to create user'', ''error'');
                }
            } catch (error) {
                console.error(''Error creating user:'', error);
                showToast(''Error creating user'', ''error'');
            }
        }

        async function changeUserPassword(username) {
            const newPassword = prompt(`Enter new password for ${username}:`);
            if (!newPassword) return;
            
            const confirmPassword = prompt(''Confirm new password:'');
            if (newPassword !== confirmPassword) {
                showToast(''Passwords do not match'', ''error'');
                return;
            }
            
            try {
                const token = localStorage.getItem(''authToken'');
                const response = await fetch(''http://localhost:8080/api/auth/change-password'', {
                    method: ''POST'',
                    headers: { 
                        ''Content-Type'': ''application/json'',
                        ''Authorization'': `Bearer ${token}`
                    },
                    body: JSON.stringify({ 
                        username, 
                        new_password: newPassword 
                    })
                });
                
                if (response.ok) {
                    showToast(''Password changed successfully!'', ''success'');
                } else {
                    const data = await response.json();
                    showToast(data.error || ''Failed to change password'', ''error'');
                }
            } catch (error) {
                console.error(''Error changing password:'', error);
                showToast(''Error changing password'', ''error'');
            }
        }

        function showToast(message, type = ''info'') {
            const container = document.getElementById(''toastContainer'');
            const toast = document.createElement(''div'');
            toast.className = `toast ${type}`;
            const icon = type === ''success'' ? '''' : type === ''error'' ? '''' : ''ℹ'';
            toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function loadState() {
            state.isLoggedIn = !!localStorage.getItem(''authToken'');
            state.currentLang = localStorage.getItem(''lang'') || ''de'';
            state.currentTheme = localStorage.getItem(''theme'') || ''light'';
        }

        init();
    </script>
</body>
</html>